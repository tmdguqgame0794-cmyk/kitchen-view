<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>주문관리 테이블 • 그룹표시(1+2+3) · 완료색상 · Firebase 동기화</title>
<style>
:root{
  --bg:#cbd5e1; --card:#ffffff; --line:#dde3ea; --muted:#475569;
  --green:#16a34a; --yellow:#ca8a04; --red:#dc2626;
  --rowOdd:#eef2f6; --rowEven:#e9edf2; --deadline:#ffe2e2;
  --accent:#2563eb; --accent-ink:#fff;
  --done:#dcfce7; --done-border:#86efac;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Helvetica,Arial,sans-serif;color:#0f172a}
.wrap{padding:8px 8px 18px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0 8px}
.btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-size:13px;color:#334155;cursor:pointer}
.btn.primary{background:var(--accent);color:var(--accent-ink);border-color:#1d4ed8}
.btn.warn{border-color:#ef4444;color:#ef4444}
.grid{display:grid;width:100%;column-gap:6px;row-gap:0}
.grid{grid-template-columns: 230px repeat(6,0.62fr) repeat(3,0.68fr) 210px 54px 140px}
.header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line);font-weight:700;padding:6px 8px;text-align:center}
.cell{border-bottom:1px solid var(--line);padding:2px 6px;min-height:32px;display:flex;align-items:center;justify-content:center;background:transparent}
.row-odd{background:var(--rowOdd)}
.row-even{background:var(--rowEven)}
.done-row{background:var(--done)!important; border-bottom-color:var(--done-border)!important}
.left{position:sticky;left:0;z-index:3;justify-content:flex-start;padding-left:10px;border-right:1px solid var(--line)}
.left .meta{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;white-space:nowrap;overflow:hidden}
.left .title{max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.small{font-size:12px;color:#64748b}
.rowReset{margin-left:auto}
.togs{display:flex;gap:6px}
.tog{
  position:relative;
  height:24px;min-width:26px;border-radius:8px;border:1px solid #cbd5e1;
  background:#fff;font-weight:800;font-size:12px;color:#334155;
  display:flex;align-items:center;justify-content:center;padding:0 6px;cursor:pointer
}
.tog[aria-pressed="true"]{color:#fff;border-color:rgba(0,0,0,.08)}
.tog.idx1[aria-pressed="true"]{background:var(--green)}
.tog.idx2[aria-pressed="true"]{background:var(--yellow)}
.tog.idx3[aria-pressed="true"]{background:var(--red)}
.tog.served::after{
  content:"✕";
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-weight:900;
  text-shadow:0 0 2px #000, 0 0 2px #000;
  pointer-events:none;
}
/* beverage */
.bevbox{display:grid;grid-template-columns:repeat(3,1fr);gap:0;width:100%}
.bevcell{display:flex;align-items:center;justify-content:center;gap:4px}
.bevbtn{height:22px;min-width:22px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;color:#1f2937;font-weight:800;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 6px}
.bevbtn.chk{border-color:#64748b}
.bevbtn.on{background:#0f172a;color:#fff;border-color:#0f172a}
.bevqty{min-width:22px;text-align:center;font-weight:800;color:#111827}
/* time */
.timebox{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;width:100%}
.timebtn{justify-self:start}
.timetxt{justify-self:start;text-align:left;font-variant-numeric:tabular-nums;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.price{text-align:right;font-weight:800;width:100%;padding-right:6px}
.footer{background:#f8fafc;border-top:1px solid var(--line);position:sticky;bottom:0}
.total{font-weight:800}
.deadline{background:var(--deadline)!important}
.cell{line-height:1}
.grid .cell{min-height:30px}
input[type="checkbox"]{width:16px;height:16px}
.groupnums{font-weight:900;color:#0f172a;background:#e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button id="resetAll" class="btn">전체 초기화</button>
    <button id="toggleSelect" class="btn">합석 선택</button>
    <button id="makeGroup" class="btn primary" disabled>그룹 만들기</button>
    <button id="breakGroup" class="btn warn" disabled>그룹 해제</button>
  </div>
  <div id="grid" class="grid"></div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
(function(){
  var CONFIG={
    menus:["우삼겹숙주볶음","치즈김치전","만두계란탕","불닭콘치즈","치즈콘계란말이","두부김치"],
    buttonsPerCell:3,
    prices:{"우삼겹숙주볶음":18000,"치즈김치전":12000,"만두계란탕":16000,"불닭콘치즈":12000,"치즈콘계란말이":11000,"두부김치":12000,"COLA":2000,"CIDER":2000,"ZERO":2000},
    tables:18,
    storageKey:"order-grid-v6-8s-compact-v4-bev3-downloadable",
    warnMs:10*60*1000
  };
  var STATE_OFF=0, STATE_ACTIVE=1, STATE_SERVED=2;

  // Firebase
  var firebaseConfig = {
    apiKey: "AIzaSyCWBPv3YgGKOH0b1e59I3QG9SfRtcNZSDY",
    authDomain: "chookjae-8e133.firebaseapp.com",
    projectId: "chookjae-8e133",
    storageBucket: "chookjae-8e133.firebasestorage.app",
    messagingSenderId: "82575498649",
    appId: "1:82575498649:web:364e9c286a9f3ae7474708",
    measurementId: "G-BQ95TPG37V",
    databaseURL: "https://chookjae-8e133-default-rtdb.firebaseio.com"
  };
  var ROOM_ID = "CHOOKJAE";
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  function publishTotals(obj){
    try{
      obj.updatedAt = Date.now();
      firebase.database().ref('orders/'+ROOM_ID+'/footerTotals').set(obj);
    }catch(e){}
  }

  function emptyRow(){
    return {
      menu: CONFIG.menus.map(function(){ return Array(CONFIG.buttonsPerCell).fill(STATE_OFF); }),
      bev: { COLA:{qty:0, served:false}, CIDER:{qty:0, served:false}, ZERO:{qty:0, served:false} },
      time:null,timePlus:null,timeStamp:null,
      done:false, groupId:null
    };
  }
  function emptyStore(){ return { rows:Array.from({length:CONFIG.tables}, emptyRow), groups:[], nextId:1 }; }
  function load(){
    try{
      var raw=localStorage.getItem(CONFIG.storageKey);
      if(raw){ var p=JSON.parse(raw); if(p && Array.isArray(p.rows) && Array.isArray(p.groups)) return p; }
    }catch(e){}
    return emptyStore();
  }
  var store = load(); var rows=store.rows; var groups=store.groups;
  function save(){ try{ localStorage.setItem(CONFIG.storageKey, JSON.stringify(store)); }catch(e){} }

  var $=function(sel){ return document.querySelector(sel); };
  var grid=$("#grid");
  var fmtWon=new Intl.NumberFormat('ko-KR');
  var pad2=function(n){ return String(n).padStart(2,'0'); };
  var nowHHMM=function(){ var d=new Date(); return pad2(d.getHours())+":"+pad2(d.getMinutes()); };
  var plus2hHHMM=function(){ var d=new Date(); d.setHours(d.getHours()+2); return pad2(d.getHours())+":"+pad2(d.getMinutes()); };

  var countActive = function(arr){ return arr.filter(function(v){ return v===STATE_ACTIVE; }).length; };
  var countOrdered = function(arr){ return arr.filter(function(v){ return v!==STATE_OFF; }).length; };
  function bevActiveQty(b){ return b.served ? 0 : b.qty; }
  function bevTotalQty(b){ return b.qty; }

  function rowPrice(r){
    var sum=0;
    r.menu.forEach(function(c,i){ sum += countOrdered(c) * (CONFIG.prices[CONFIG.menus[i]]||0); });
    sum += bevTotalQty(r.bev.COLA)*CONFIG.prices.COLA + bevTotalQty(r.bev.CIDER)*CONFIG.prices.CIDER + bevTotalQty(r.bev.ZERO)*CONFIG.prices.ZERO;
    return sum;
  }

  function groupBy(id){ for(var i=0;i<groups.length;i++){ if(groups[i].id===id) return groups[i]; } return null; }
  function groupMembers(id){ var g=groupBy(id); return g? g.members.slice():[]; }
  function groupLeader(id){ var m=groupMembers(id); return m.length? Math.min.apply(null,m): null; }
  function groupAnyActive(id){
    return groupMembers(id).some(function(i){
      var r=rows[i];
      var menus = r.menu.some(function(c){ return countActive(c)>0; });
      var bevs = bevActiveQty(r.bev.COLA)+bevActiveQty(r.bev.CIDER)+bevActiveQty(r.bev.ZERO) > 0;
      return menus || bevs;
    });
  }
  function groupAnyOrdered(id){
    return groupMembers(id).some(function(i){
      var r=rows[i];
      var menus = r.menu.some(function(c){ return countOrdered(c)>0; });
      var bevs = bevTotalQty(r.bev.COLA)+bevTotalQty(r.bev.CIDER)+bevTotalQty(r.bev.ZERO) > 0;
      return menus || bevs;
    });
  }
  function groupTotalPrice(id){ return groupMembers(id).reduce(function(acc,i){ return acc+rowPrice(rows[i]); },0); }

  /* ✅ 변경 1: 항상 각 행의 timeStamp만 사용 (그룹 공유 금지) */
  function isDeadlineSoon(r){
    var ts = r.timeStamp;           // <-- was: group time when grouped
    if(!ts) return false;
    var deadline = ts + 2*60*60*1000;
    return (deadline - Date.now()) <= CONFIG.warnMs;
  }

  var ui={select:false, selected:new Set()};

  function header(txt){ var d=document.createElement('div'); d.className="header"; d.textContent=txt; grid.appendChild(d); }
  function cell(cls, rowIndex){ var d=document.createElement('div'); d.className="cell "+cls; d.dataset.row=rowIndex; return d; }

  function rerenderGroupIfNeeded(rowIndex){
    var gid = rows[rowIndex].groupId;
    if(!gid) return;
    groupMembers(gid).forEach(function(idx){ renderRow(idx); });
  }

  function drawMenuButtons(container, rIdx, mIdx){
    var row=rows[rIdx]; var states=row.menu[mIdx];
    var wrap=document.createElement('div'); wrap.className="togs";
    states.forEach(function(st, i){
      var b=document.createElement('button'); b.className="tog idx"+(i+1); b.textContent=String(i+1);
      b.setAttribute('aria-pressed', st!==STATE_OFF ? 'true' : 'false');
      if(st===STATE_SERVED) b.classList.add('served');
      b.onclick=function(){
        var cur=states[i];
        if(cur===STATE_OFF){
          for(var k=0;k<=i;k++){ if(states[k]!==STATE_SERVED) states[k]=STATE_ACTIVE; }
          for(var k2=i+1;k2<states.length;k2++){ if(states[k2]!==STATE_SERVED) states[k2]=STATE_OFF; }
        }else if(cur===STATE_ACTIVE){
          states[i]=STATE_SERVED;
        }else{
          states[i]=STATE_OFF;
        }
        save(); renderRow(rIdx); rerenderGroupIfNeeded(rIdx);
      };
      wrap.appendChild(b);
    });
    container.innerHTML=""; container.appendChild(wrap);
  }

  function drawBeverage(container, rIdx, key){
    var b = rows[rIdx].bev[key];
    var box=document.createElement('div'); box.className="bevcell";
    var minus=document.createElement('button'); minus.className="bevbtn"; minus.textContent="−";
    var chk=document.createElement('button'); chk.className="bevbtn chk"+(b.served?" on":""); chk.textContent="✓";
    var plus=document.createElement('button'); plus.className="bevbtn"; plus.textContent="+";
    var qty=document.createElement('div'); qty.className="bevqty"; qty.textContent=String(b.qty);
    minus.onclick=function(){ if(b.qty>0){ b.qty--; if(b.qty===0) b.served=false; save(); renderRow(rIdx); rerenderGroupIfNeeded(rIdx);} };
    plus.onclick =function(){ b.qty++; b.served=false; save(); renderRow(rIdx); rerenderGroupIfNeeded(rIdx); };
    chk.onclick  =function(){ if(b.qty>0){ b.served=!b.served; save(); renderRow(rIdx); rerenderGroupIfNeeded(rIdx);} };
    box.appendChild(minus); box.appendChild(qty); box.appendChild(plus); box.appendChild(chk);
    container.innerHTML=""; container.appendChild(box);
  }

  /* ✅ 변경 2: 합석 여부와 무관하게 '해당 행'만 시간 기록/표시 */
  function drawTime(container, rIdx){
    var row=rows[rIdx];

    // 항상 row 자체를 사용 (그룹 공유 객체 사용 금지)
    function getObj(){ return row; }
    function setObj(o){
      row.time = o.time;
      row.timePlus = o.timePlus;
      row.timeStamp = o.timeStamp;
    }

    var timebox=document.createElement('div'); timebox.className="timebox";
    var btn=document.createElement('button'); btn.className="btn primary timebtn"; btn.textContent="시간";
    var txt=document.createElement('div'); txt.className="timetxt"; timebox.appendChild(btn); timebox.appendChild(txt);
    function draw(){
      var o=getObj();
      if(!o.time) txt.textContent="";
      else if(o.time && !o.timePlus) txt.textContent=o.time;
      else txt.textContent=o.time+" (+2h "+o.timePlus+")";
      var soon = isDeadlineSoon(row) && !row.done;
      var rowCells=document.querySelectorAll('.cell[data-row="'+rIdx+'"]');
      Array.prototype.forEach.call(rowCells, function(n){ n.classList.toggle('deadline', soon); });
    }
    btn.onclick=function(){
      var o=getObj();
      if(!o.time){ setObj({time:nowHHMM(), timePlus:null, timeStamp:Date.now()}); }
      else if(o.time && !o.timePlus){ setObj({time:nowHHMM(), timePlus:plus2hHHMM(), timeStamp:Date.now()}); }
      else { setObj({time:null,timePlus:null,timeStamp:null}); }
      save(); draw(); /* 그룹 재렌더는 유지해도 상태 공유가 없으니 영향 없음 */
      rerenderGroupIfNeeded(rIdx);
    };
    draw(); container.innerHTML=""; container.appendChild(timebox);
  }

  function isCompletable(rIdx){
    var r=rows[rIdx];
    var menusActive = r.menu.some(function(c){ return countActive(c)>0; });
    var bevsActive  = (bevActiveQty(r.bev.COLA)+bevActiveQty(r.bev.CIDER)+bevActiveQty(r.bev.ZERO))>0;
    var menusOrdered = r.menu.some(function(c){ return countOrdered(c)>0; });
    var bevsOrdered  = (bevTotalQty(r.bev.COLA)+bevTotalQty(r.bev.CIDER)+bevTotalQty(r.bev.ZERO))>0;
    if(r.groupId){
      var id=r.groupId;
      return groupAnyOrdered(id) && !groupAnyActive(id);
    }else{
      return (menusOrdered||bevsOrdered) && !(menusActive||bevsActive);
    }
  }

  function renderHeader(){
    grid.innerHTML="";
    header("테이블");
    CONFIG.menus.forEach(function(m){ header(m); });
    header("콜라"); header("사이다"); header("제로콜라");
    header("시간"); header("완료"); header("가격");
  }

  function currentTotalsObject(){
    var sums = Array(CONFIG.menus.length + 3).fill(0);
    rows.forEach(function(r){
      r.menu.forEach(function(c,i){ sums[i]+=countActive(c); });
      if(!r.bev.COLA.served) sums[CONFIG.menus.length]+=r.bev.COLA.qty;
      if(!r.bev.CIDER.served) sums[CONFIG.menus.length+1]+=r.bev.CIDER.qty;
      if(!r.bev.ZERO.served)  sums[CONFIG.menus.length+2]+=r.bev.ZERO.qty;
    });
    var obj = {};
    CONFIG.menus.forEach(function(name, i){ obj[name]=sums[i]||0; });
    obj["콜라"]=sums[CONFIG.menus.length]||0;
    obj["사이다"]=sums[CONFIG.menus.length+1]||0;
    obj["제로콜라"]=sums[CONFIG.menus.length+2]||0;
    return obj;
  }

  function renderFooter(){
    var sums = Array(CONFIG.menus.length + 3).fill(0);
    rows.forEach(function(r){
      r.menu.forEach(function(c,i){ sums[i]+=countActive(c); });
      if(!r.bev.COLA.served) sums[CONFIG.menus.length]+=r.bev.COLA.qty;
      if(!r.bev.CIDER.served) sums[CONFIG.menus.length+1]+=r.bev.CIDER.qty;
      if(!r.bev.ZERO.served)  sums[CONFIG.menus.length+2]+=r.bev.ZERO.qty;
    });
    var left=cell("footer total left",""); left.textContent="총 합계"; grid.appendChild(left);
    sums.forEach(function(v){ var d=cell("footer total",""); d.textContent=String(v); grid.appendChild(d); });
    grid.appendChild(cell("footer","")); grid.appendChild(cell("footer","")); grid.appendChild(cell("footer",""));
    publishTotals( currentTotalsObject() );
  }

  function renderLeftCell(leftEl, i){
    leftEl.innerHTML="";
    var meta=document.createElement('div'); meta.className="meta";

    if(ui.select){
      var label=document.createElement('label'); label.className="sel"; label.style.display="flex"; label.style.alignItems="center"; label.style.gap="6px";
      var cb=document.createElement('input'); cb.type="checkbox"; cb.checked = ui.selected.has(i);
      cb.onchange=function(){ if(cb.checked) ui.selected.add(i); else ui.selected.delete(i); updateGroupButtons(); };
      label.appendChild(cb);
      var title=document.createElement('div'); title.className="title"; title.textContent=(i+1)+"번 테이블";
      label.appendChild(title);
      meta.appendChild(label);
    }else{
      var title2=document.createElement('div'); title2.className="title"; title2.textContent=(i+1)+"번 테이블"; meta.appendChild(title2);
      var gid = rows[i].groupId;
      if(gid){
        var nums = groupMembers(gid).map(function(x){return (x+1);}).join("+");
        var pill = document.createElement('span'); pill.className="groupnums"; pill.textContent = nums;
        meta.appendChild(pill);
      }
    }

    var reset=document.createElement('button'); reset.className="btn rowReset small"; reset.textContent="행 초기화";
    reset.onclick=function(){ var gid=rows[i].groupId; rows[i]=emptyRow(); rows[i].groupId=gid; save(); fullRender(); };
    meta.appendChild(reset);
    leftEl.appendChild(meta);
  }

  function setRowDoneStyles(i){
    var cells=document.querySelectorAll('.cell[data-row="'+i+'"]');
    Array.prototype.forEach.call(cells, function(n){
      n.classList.toggle('done-row', !!rows[i].done);
    });
  }

  function renderRow(i){
    var rowCells = Array.prototype.slice.call(grid.querySelectorAll('.cell[data-row="'+i+'"]'));
    if(rowCells.length===0) return;
    var left=rowCells.shift();
    renderLeftCell(left, i);

    for(var m=0;m<CONFIG.menus.length;m++){
      var c=rowCells.shift(); drawMenuButtons(c,i,m);
    }
    drawBeverage(rowCells.shift(), i, "COLA");
    drawBeverage(rowCells.shift(), i, "CIDER");
    drawBeverage(rowCells.shift(), i, "ZERO");

    drawTime(rowCells.shift(), i);

    var doneCell=rowCells.shift(); doneCell.innerHTML="";
    var chk=document.createElement('input'); chk.type="checkbox"; chk.checked=rows[i].done;
    chk.disabled=!isCompletable(i);
    chk.onchange=function(){
      if(!chk.checked){ rows[i].done=false; save(); renderRow(i); rerenderGroupIfNeeded(i); return; }
      if(rows[i].groupId){
        var id=rows[i].groupId; var leader=groupLeader(id);
        if(i!==leader){ chk.checked=false; return; }
        if(!(groupAnyOrdered(id) && !groupAnyActive(id))){ chk.checked=false; return; }
        groupMembers(id).forEach(function(t){ rows[t].done=true; });
      }else{
        if(!isCompletable(i)){ chk.checked=false; return; }
        rows[i].done=true;
      }
      save(); renderRow(i); rerenderGroupIfNeeded(i);
    };
    doneCell.appendChild(chk);

    var priceCell=rowCells.shift(); priceCell.classList.add("price");
    var text = fmtWon.format(rowPrice(rows[i]))+"원";
    var gidL=rows[i].groupId, lead=gidL?groupLeader(gidL):null;
    if(gidL && i===lead) text += " · 그룹 총 "+fmtWon.format(groupTotalPrice(gidL))+"원";
    priceCell.textContent=text;

    var soon = isDeadlineSoon(rows[i]) && !rows[i].done;
    Array.prototype.forEach.call(document.querySelectorAll('.cell[data-row="'+i+'"]'), function(n){ n.classList.toggle('deadline', soon); });

    setRowDoneStyles(i);
    renderFooterTotalsOnly();
    updateGroupButtons();
  }

  function renderFooterTotalsOnly(){
    var totalCells = document.querySelectorAll('.footer.total');
    if(totalCells.length===0) return;
    var sums = Array(CONFIG.menus.length + 3).fill(0);
    rows.forEach(function(r){
      r.menu.forEach(function(c,i){ sums[i]+=countActive(c); });
      if(!r.bev.COLA.served) sums[CONFIG.menus.length]+=r.bev.COLA.qty;
      if(!r.bev.CIDER.served) sums[CONFIG.menus.length+1]+=r.bev.CIDER.qty;
      if(!r.bev.ZERO.served)  sums[CONFIG.menus.length+2]+=r.bev.ZERO.qty;
    });
    for(var k=0;k<sums.length;k++){
      totalCells[k+1].textContent=String(sums[k]);
    }
    publishTotals( currentTotalsObject() );
  }

  function fullRender(){
    renderHeader();
    for(var i=0;i<rows.length;i++){
      var rc = (i%2===0) ? "row-odd" : "row-even";
      var left=cell(rc+" left", i);
      grid.appendChild(left);
      renderLeftCell(left, i);

      for(var m=0;m<CONFIG.menus.length;m++){ var d=cell(rc, i); grid.appendChild(d); drawMenuButtons(d,i,m); }
      var c1=cell(rc,i); c1.innerHTML='<div class="bevbox"></div>'; grid.appendChild(c1); drawBeverage(c1,i,"COLA");
      var c2=cell(rc,i); c2.innerHTML='<div class="bevbox"></div>'; grid.appendChild(c2); drawBeverage(c2,i,"CIDER");
      var c3=cell(rc,i); c3.innerHTML='<div class="bevbox"></div>'; grid.appendChild(c3); drawBeverage(c3,i,"ZERO");

      var tcell=cell(rc,i); grid.appendChild(tcell); drawTime(tcell,i);

      var dcell=cell(rc,i); grid.appendChild(dcell); var chk=document.createElement('input'); chk.type="checkbox"; chk.checked=rows[i].done; chk.disabled=!isCompletable(i);
      (function(iRef, chkRef){
        chk.addEventListener('change', function(){
          if(!chkRef.checked){ rows[iRef].done=false; save(); renderRow(iRef); rerenderGroupIfNeeded(iRef); return; }
          if(rows[iRef].groupId){
            var id=rows[iRef].groupId; var leader=groupLeader(id);
            if(iRef!==leader){ chkRef.checked=false; return; }
            if(!(groupAnyOrdered(id) && !groupAnyActive(id))){ chkRef.checked=false; return; }
            groupMembers(id).forEach(function(t){ rows[t].done=true; });
          }else{
            if(!isCompletable(iRef)){ chkRef.checked=false; return; }
            rows[iRef].done=true;
          }
          save(); renderRow(iRef); rerenderGroupIfNeeded(iRef);
        });
      })(i, chk);
      dcell.appendChild(chk);

      var pcell=cell(rc+" price",i); grid.appendChild(pcell);
      var text2 = fmtWon.format(rowPrice(rows[i]))+"원";
      var gid2=rows[i].groupId, lead2=gid2?groupLeader(gid2):null;
      if(gid2 && i===lead2) text2 += " · 그룹 총 "+fmtWon.format(groupTotalPrice(gid2))+"원";
      pcell.textContent=text2;

      setRowDoneStyles(i);
    }
    renderFooter();
    publishTotals( currentTotalsObject() );
    updateGroupButtons();
  }

  // toolbar
  var $reset=$("#resetAll"), $toggle=$("#toggleSelect"), $make=$("#makeGroup"), $break=$("#breakGroup");
  $reset.onclick=function(){ if(!confirm("모든 내용을 초기화할까요?")) return; store = emptyStore(); rows=store.rows; groups=store.groups; ui.selected.clear(); ui.select=false; save(); fullRender(); };
  $toggle.onclick=function(){ ui.select=!ui.select; updateAllLeftCellsForSelectMode(); updateGroupButtons(); };
  function updateAllLeftCellsForSelectMode(){
    for(var i=0;i<rows.length;i++){
      var left = grid.querySelector('.cell.left[data-row="'+i+'"]');
      if(left){ renderLeftCell(left, i); }
    }
  }
  function updateGroupButtons(){
    var arr=Array.from(ui.selected);
    $make.disabled = !(ui.select && arr.length>=2 && arr.every(function(i){ return rows[i].groupId===null; }));
    $break.disabled = !(ui.select && arr.some(function(i){ return rows[i].groupId!==null; }));
  }
  $make.onclick=function(){
    var arr=Array.from(ui.selected).sort(function(a,b){return a-b;}); if(arr.length<2) return;
    var id=store.nextId++; var g={id:id, members:arr, time:null,timePlus:null,timeStamp:null};
    groups.push(g); arr.forEach(function(i){ rows[i].groupId=id; });
    ui.selected.clear(); ui.select=false; save(); fullRender();
  };
  $break.onclick=function(){
    var arr=Array.from(ui.selected); if(arr.length===0) return;
    var by={}; arr.forEach(function(i){ var gid=rows[i].groupId; if(gid!==null && gid!==undefined){ (by[gid]||(by[gid]=[])).push(i);} });
    Object.keys(by).forEach(function(gidStr){
      var gid=Number(gidStr); var g=groupBy(gid); if(!g) return;
      var list=by[gidStr];
      list.forEach(function(i){ rows[i].groupId=null; if(g.time){ rows[i].time=g.time; rows[i].timePlus=g.timePlus; rows[i].timeStamp=g.timeStamp; } });
      g.members = g.members.filter(function(i){ return list.indexOf(i)===-1; });
      if(g.members.length===0){ groups = groups.filter(function(x){ return x.id!==gid; }); }
    });
    ui.selected.clear(); ui.select=false; save(); fullRender();
  };

  fullRender();
})();
</script>
</body>
</html>
