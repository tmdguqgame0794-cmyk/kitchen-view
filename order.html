<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>주문관리 테이블 v6.8s • Compact v4 (음료 3분할 + Firebase)</title>
<style>
:root{
  --bg:#cbd5e1; --card:#ffffff; --line:#dde3ea; --muted:#475569;
  --green:#16a34a; --yellow:#ca8a04; --red:#dc2626; --bev:#334155;
  --rowOdd:#eef2f6; --rowEven:#e9edf2; --deadline:#ffe2e2;
  --accent:#2563eb; --accent-ink:#fff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Helvetica,Arial,sans-serif;color:#0f172a}
.wrap{padding:8px 8px 18px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0 8px}
.btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-size:13px;color:#334155;cursor:pointer}
.btn.primary{background:var(--accent);color:var(--accent-ink);border-color:#1d4ed8}
.btn.warn{border-color:#ef4444;color:#ef4444}
.grid{display:grid;width:100%;column-gap:6px;row-gap:0}
/* columns: left 210px, 6 menus (0.62fr), 3 beverages (0.68fr), time 210px, done 54px, price 120px */
.grid{grid-template-columns: 210px repeat(6,0.62fr) repeat(3,0.68fr) 210px 54px 120px}
.header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line);font-weight:700;padding:6px 8px;text-align:center}
.cell{border-bottom:1px solid var(--line);padding:2px 6px;min-height:32px;display:flex;align-items:center;justify-content:center;background:transparent}
.row-odd{background:var(--rowOdd)}
.row-even{background:var(--rowEven)}
.left{position:sticky;left:0;z-index:3;justify-content:flex-start;padding-left:10px;border-right:1px solid var(--line)}
.left .meta{display:flex;gap:8px;align-items:center}
.small{font-size:12px;color:#64748b}
.rowReset{margin-left:auto}
.togs{display:flex;gap:6px}

/* 토글 버튼 */
.tog{
  position:relative;
  height:24px;min-width:26px;border-radius:8px;border:1px solid #cbd5e1;
  background:#fff;font-weight:800;font-size:12px;color:#334155;
  display:flex;align-items:center;justify-content:center;padding:0 6px;cursor:pointer
}
.tog[aria-pressed="true"]{color:#fff;border-color:rgba(0,0,0,.08)}
.tog.idx1[aria-pressed="true"]{background:var(--green)}
.tog.idx2[aria-pressed="true"]{background:var(--yellow)}
.tog.idx3[aria-pressed="true"]{background:var(--red)}
.tog.served::after{
  content:"✕";
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-weight:900;
  text-shadow:0 0 2px #000, 0 0 2px #000;
  pointer-events:none;
}

/* beverage control */
.bevbox{display:grid;grid-template-columns:repeat(3,1fr);gap:0;width:100%}
.bevcell{display:flex;align-items:center;justify-content:center;gap:4px}
.bevbtn{height:22px;min-width:22px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;color:#1f2937;font-weight:800;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 6px}
.bevbtn.chk{border-color:#64748b}
.bevbtn.on{background:#0f172a;color:#fff;border-color:#0f172a}
.bevqty{min-width:22px;text-align:center;font-weight:800;color:#111827}
/* time */
.timebox{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;width:100%}
.timebtn{justify-self:start}
.timetxt{justify-self:start;text-align:left;font-variant-numeric:tabular-nums;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.price{text-align:right;font-weight:800;width:100%;padding-right:6px}
.footer{background:#f8fafc;border-top:1px solid var(--line);position:sticky;bottom:0}
.total{font-weight:800}
.deadline{background:var(--deadline)!important}
/* Compact row height */
.cell{line-height:1}
.grid .cell{min-height:30px}
/* checkbox */
input[type="checkbox"]{width:16px;height:16px}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button id="resetAll" class="btn">전체 초기화</button>
    <button id="toggleSelect" class="btn">합석 선택</button>
    <button id="makeGroup" class="btn primary" disabled>그룹 만들기</button>
    <button id="breakGroup" class="btn warn" disabled>그룹 해제</button>
  </div>
  <div id="grid" class="grid"></div>
</div>

<!-- Firebase v8 (file://, Pages 모두 호환) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
(function(){
  const CONFIG={
    menus:["우삼겹숙주볶음","치즈김치전","만두계란탕","불닭콘치즈","치즈콘계란말이","두부김치"],
    buttonsPerCell:3,
    prices:{"우삼겹숙주볶음":18000,"치즈김치전":12000,"만두계란탕":16000,"불닭콘치즈":12000,"치즈콘계란말이":11000,"두부김치":12000,"COLA":2000,"CIDER":2000,"ZERO":2000},
    tables:18,
    storageKey:"order-grid-v6-8s-compact-v4-bev3-fb",
    warnMs:10*60*1000
  };
  const STATE_OFF=0, STATE_ACTIVE=1, STATE_SERVED=2;

  // ---- Firebase ----
  var firebaseConfig = {
    apiKey: "AIzaSyCWBPv3YgGKOH0b1e59I3QG9SfRtcNZSDY",
    authDomain: "chookjae-8e133.firebaseapp.com",
    projectId: "chookjae-8e133",
    storageBucket: "chookjae-8e133.firebasestorage.app",
    messagingSenderId: "82575498649",
    appId: "1:82575498649:web:364e9c286a9f3ae7474708",
    measurementId: "G-BQ95TPG37V",
    databaseURL: "https://chookjae-8e133-default-rtdb.firebaseio.com"
  };
  var ROOM_ID = "CHOOKJAE";
  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();
  function publishTotals(obj){
    try{
      obj.updatedAt = Date.now();
      firebase.database().ref('orders/'+ROOM_ID+'/footerTotals').set(obj);
    }catch(e){ /* ignore offline */ }
  }

  // data
  function emptyRow(){
    return {
      menu: CONFIG.menus.map(()=>Array(CONFIG.buttonsPerCell).fill(STATE_OFF)),
      bev: { COLA:{qty:0, served:false}, CIDER:{qty:0, served:false}, ZERO:{qty:0, served:false} },
      time:null,timePlus:null,timeStamp:null,
      done:false, groupId:null
    };
  }
  function emptyStore(){
    return { rows:Array.from({length:CONFIG.tables}, emptyRow), groups:[], nextId:1 };
  }
  function load(){
    try{
      const raw=localStorage.getItem(CONFIG.storageKey);
      if(raw){ const p=JSON.parse(raw); if(p && Array.isArray(p.rows) && Array.isArray(p.groups)) return p; }
    }catch(e){}
    return emptyStore();
  }
  let store = load(); let rows=store.rows; let groups=store.groups;

  function save(){ try{ localStorage.setItem(CONFIG.storageKey, JSON.stringify(store)); }catch(e){} }

  // utils
  const $=sel=>document.querySelector(sel);
  const grid=$("#grid");
  const fmtWon=new Intl.NumberFormat('ko-KR');
  const pad2=n=>String(n).padStart(2,'0');
  const nowHHMM=()=>{const d=new Date();return pad2(d.getHours())+":"+pad2(d.getMinutes())};
  const plus2hHHMM=()=>{const d=new Date();d.setHours(d.getHours()+2);return pad2(d.getHours())+":"+pad2(d.getMinutes())};

  const countActive = arr => arr.filter(v=>v===STATE_ACTIVE).length;
  const countOrdered = arr => arr.filter(v=>v!==STATE_OFF).length;

  function bevActiveQty(b){ return b.served ? 0 : b.qty; }
  function bevTotalQty(b){ return b.qty; }

  function rowPrice(r){
    let sum=0;
    r.menu.forEach((c,i)=> sum += countOrdered(c) * (CONFIG.prices[CONFIG.menus[i]]||0));
    sum += bevTotalQty(r.bev.COLA)*CONFIG.prices.COLA + bevTotalQty(r.bev.CIDER)*CONFIG.prices.CIDER + bevTotalQty(r.bev.ZERO)*CONFIG.prices.ZERO;
    return sum;
  }

  // group helpers
  function groupBy(id){ return groups.find(g=>g.id===id)||null; }
  function groupMembers(id){ const g=groupBy(id); return g? g.members.slice():[]; }
  function groupLeader(id){ const m=groupMembers(id); return m.length? Math.min(...m): null; }
  function groupAnyActive(id){
    return groupMembers(id).some(i=>{
      const r=rows[i];
      const menus = r.menu.some(c=>countActive(c)>0);
      const bevs = bevActiveQty(r.bev.COLA)+bevActiveQty(r.bev.CIDER)+bevActiveQty(r.bev.ZERO) > 0;
      return menus || bevs;
    });
  }
  function groupAnyOrdered(id){
    return groupMembers(id).some(i=>{
      const r=rows[i];
      const menus = r.menu.some(c=>countOrdered(c)>0);
      const bevs = bevTotalQty(r.bev.COLA)+bevTotalQty(r.bev.CIDER)+bevTotalQty(r.bev.ZERO) > 0;
      return menus || bevs;
    });
  }
  function groupTotalPrice(id){ return groupMembers(id).reduce((acc,i)=>acc+rowPrice(rows[i]),0); }

  function isDeadlineSoon(r){
    const ts = r.groupId? (groupBy(r.groupId)?.timeStamp||null) : r.timeStamp;
    if(!ts) return false;
    const deadline = ts + 2*60*60*1000;
    return (deadline - Date.now()) <= CONFIG.warnMs;
  }

  // UI state
  const ui={select:false, selected:new Set()};

  // render helpers
  function header(txt){ const d=document.createElement('div'); d.className="header"; d.textContent=txt; grid.appendChild(d); }
  function cell(cls, rowIndex){ const d=document.createElement('div'); d.className="cell "+cls; d.dataset.row=rowIndex; return d; }

  function drawMenuButtons(container, rIdx, mIdx){
    const row=rows[rIdx]; const states=row.menu[mIdx];
    const wrap=document.createElement('div'); wrap.className="togs";
    states.forEach((st, i)=>{
      const b=document.createElement('button'); b.className="tog idx"+(i+1); b.textContent=String(i+1);
      b.setAttribute('aria-pressed', st!==STATE_OFF ? 'true' : 'false');
      b.classList.toggle('served', st===STATE_SERVED);

      b.onclick=()=>{
        const cur=states[i];
        if(cur===STATE_OFF){
          for(let k=0;k<=i;k++){ if(states[k]!==STATE_SERVED) states[k]=STATE_ACTIVE; }
          for(let k=i+1;k<states.length;k++){ if(states[k]!==STATE_SERVED) states[k]=STATE_OFF; }
        }else if(cur===STATE_ACTIVE){
          states[i]=STATE_SERVED;
        }else{
          states[i]=STATE_OFF;
        }
        save(); renderRow(rIdx);
      };
      wrap.appendChild(b);
    });
    container.innerHTML=""; container.appendChild(wrap);
  }

  function drawBeverage(container, rIdx, key){
    const b = rows[rIdx].bev[key];
    const box=document.createElement('div'); box.className="bevcell";
    const minus=document.createElement('button'); minus.className="bevbtn"; minus.textContent="−";
    const chk=document.createElement('button'); chk.className="bevbtn chk"+(b.served?" on":""); chk.textContent="✓";
    const plus=document.createElement('button'); plus.className="bevbtn"; plus.textContent="+";
    const qty=document.createElement('div'); qty.className="bevqty"; qty.textContent=String(b.qty);

    minus.onclick=()=>{ if(b.qty>0){ b.qty--; if(b.qty===0) b.served=false; save(); renderRow(rIdx); } };
    plus.onclick =()=>{ b.qty++; b.served=false; save(); renderRow(rIdx); };
    chk.onclick  =()=>{ if(b.qty>0){ b.served=!b.served; save(); renderRow(rIdx);} };

    box.appendChild(minus); box.appendChild(qty); box.appendChild(plus); box.appendChild(chk);
    container.innerHTML=""; container.appendChild(box);
  }

  function drawTime(container, rIdx){
    const row=rows[rIdx];
    function getObj(){ if(row.groupId){ const g=groupBy(row.groupId)||{}; return g; } return row; }
    function setObj(o){ if(row.groupId){ const g=groupBy(row.groupId); if(!g) return; g.time=o.time; g.timePlus=o.timePlus; g.timeStamp=o.timeStamp; } else { row.time=o.time; row.timePlus=o.timePlus; row.timeStamp=o.timeStamp; } }
    const timebox=document.createElement('div'); timebox.className="timebox";
    const btn=document.createElement('button'); btn.className="btn primary timebtn"; btn.textContent="시간";
    const txt=document.createElement('div'); txt.className="timetxt"; timebox.appendChild(btn); timebox.appendChild(txt);
    function draw(){
      const o=getObj();
      if(!o.time) txt.textContent="";
      else if(o.time && !o.timePlus) txt.textContent=o.time;
      else txt.textContent=o.time+" (+2h "+o.timePlus+")";
      const soon = isDeadlineSoon(row) && !row.done;
      const rowCells=document.querySelectorAll('.cell[data-row="'+rIdx+'"]');
      rowCells.forEach(n=> n.classList.toggle('deadline', soon));
    }
    btn.onclick=()=>{
      const o=getObj();
      if(!o.time){ setObj({time:nowHHMM(), timePlus:null, timeStamp:Date.now()}); }
      else if(o.time && !o.timePlus){ setObj({time:nowHHMM(), timePlus:plus2hHHMM(), timeStamp:Date.now()}); }
      else { setObj({time:null,timePlus:null,timeStamp:null}); }
      save(); draw();
    };
    draw(); container.innerHTML=""; container.appendChild(timebox);
  }

  function isCompletable(rIdx){
    const r=rows[rIdx];
    const menusActive = r.menu.some(c=>countActive(c)>0);
    const bevsActive  = (bevActiveQty(r.bev.COLA)+bevActiveQty(r.bev.CIDER)+bevActiveQty(r.bev.ZERO))>0;
    const menusOrdered = r.menu.some(c=>countOrdered(c)>0);
    const bevsOrdered  = (bevTotalQty(r.bev.COLA)+bevTotalQty(r.bev.CIDER)+bevTotalQty(r.bev.ZERO))>0;
    if(r.groupId){
      const id=r.groupId;
      return groupAnyOrdered(id) && !groupAnyActive(id);
    }else{
      return (menusOrdered||bevsOrdered) && !(menusActive||bevsActive);
    }
  }

  function renderHeader(){
    grid.innerHTML="";
    header("테이블");
    CONFIG.menus.forEach(m=> header(m));
    header("콜라"); header("사이다"); header("제로콜라");
    header("시간"); header("완료"); header("가격");
  }

  function currentTotalsObject(){
    // 진행중 기준(=ACTIVE만) — 메뉴 6 + 콜라/사이다/제로 3
    const sums = Array(CONFIG.menus.length + 3).fill(0);
    rows.forEach(r=>{
      r.menu.forEach((c,i)=> sums[i]+=countActive(c));
      if(!r.bev.COLA.served) sums[CONFIG.menus.length]+=r.bev.COLA.qty;
      if(!r.bev.CIDER.served) sums[CONFIG.menus.length+1]+=r.bev.CIDER.qty;
      if(!r.bev.ZERO.served)  sums[CONFIG.menus.length+2]+=r.bev.ZERO.qty;
    });
    const obj = {};
    CONFIG.menus.forEach((name, i)=> obj[name]=sums[i]||0);
    obj["콜라"]=sums[CONFIG.menus.length]||0;
    obj["사이다"]=sums[CONFIG.menus.length+1]||0;
    obj["제로콜라"]=sums[CONFIG.menus.length+2]||0;
    return obj;
  }

  function renderFooter(){
    const sums = Array(CONFIG.menus.length + 3).fill(0);
    rows.forEach(r=>{
      r.menu.forEach((c,i)=> sums[i]+=countActive(c));
      if(!r.bev.COLA.served) sums[CONFIG.menus.length]+=r.bev.COLA.qty;
      if(!r.bev.CIDER.served) sums[CONFIG.menus.length+1]+=r.bev.CIDER.qty;
      if(!r.bev.ZERO.served)  sums[CONFIG.menus.length+2]+=r.bev.ZERO.qty;
    });
    const left=cell("footer total left"); left.textContent="총 합계"; grid.appendChild(left);
    sums.forEach(v=>{ const d=cell("footer total"); d.textContent=String(v); grid.appendChild(d); });
    grid.appendChild(cell("footer","")); grid.appendChild(cell("footer","")); grid.appendChild(cell("footer",""));
    // ---- publish to Firebase
    publishTotals( currentTotalsObject() );
  }

  function renderRow(i){
    // replace a row by re-rendering cells for that row only
    const rowCells = Array.from(grid.querySelectorAll(`.cell[data-row="${i}"]`));
    if(rowCells.length===0) return; // first render uses full rebuild

    // left/title
    const left=rowCells.shift(); left.innerHTML="";
    const meta=document.createElement('div'); meta.className="meta";
    const title=document.createElement('div'); title.textContent=(i+1)+"번 테이블"; meta.appendChild(title);
    const reset=document.createElement('button'); reset.className="btn rowReset small"; reset.textContent="행 초기화";
    reset.onclick=()=>{ const gid=rows[i].groupId; rows[i]=emptyRow(); rows[i].groupId=gid; save(); fullRender(); };
    meta.appendChild(reset); left.appendChild(meta);

    // menus
    for(let m=0;m<CONFIG.menus.length;m++){
      const c=rowCells.shift(); drawMenuButtons(c,i,m);
    }
    // beverages
    drawBeverage(rowCells.shift(), i, "COLA");
    drawBeverage(rowCells.shift(), i, "CIDER");
    drawBeverage(rowCells.shift(), i, "ZERO");

    // time
    drawTime(rowCells.shift(), i);

    // done
    const doneCell=rowCells.shift(); doneCell.innerHTML="";
    const chk=document.createElement('input'); chk.type="checkbox"; chk.checked=rows[i].done;
    chk.disabled=!isCompletable(i);
    chk.onchange=()=>{
      if(!chk.checked){ rows[i].done=false; save(); renderRow(i); return; }
      if(rows[i].groupId){
        const id=rows[i].groupId; const leader=groupLeader(id);
        if(i!==leader){ chk.checked=false; return; }
        if(!(groupAnyOrdered(id) && !groupAnyActive(id))){ chk.checked=false; return; }
        groupMembers(id).forEach(t=> rows[t].done=true);
      }else{
        if(!isCompletable(i)){ chk.checked=false; return; }
        rows[i].done=true;
      }
      save(); renderRow(i);
    };
    doneCell.appendChild(chk);

    // price
    const priceCell=rowCells.shift(); priceCell.classList.add("price");
    let text = fmtWon.format(rowPrice(rows[i]))+"원";
    if(rows[i].groupId && i===groupLeader(rows[i].groupId)) text += " · 그룹 총 "+fmtWon.format(groupTotalPrice(rows[i].groupId))+"원";
    priceCell.textContent=text;

    // deadline highlight
    const soon = isDeadlineSoon(rows[i]) && !rows[i].done;
    document.querySelectorAll('.cell[data-row="'+i+'"]').forEach(n=> n.classList.toggle('deadline', soon));

    renderFooterTotalsOnly();
  }

  function renderFooterTotalsOnly(){
    const totalCells = grid.querySelectorAll('.footer.total');
    if(totalCells.length===0) return;
    const sums = Array(CONFIG.menus.length + 3).fill(0);
    rows.forEach(r=>{
      r.menu.forEach((c,i)=> sums[i]+=countActive(c));
      if(!r.bev.COLA.served) sums[CONFIG.menus.length]+=r.bev.COLA.qty;
      if(!r.bev.CIDER.served) sums[CONFIG.menus.length+1]+=r.bev.CIDER.qty;
      if(!r.bev.ZERO.served)  sums[CONFIG.menus.length+2]+=r.bev.ZERO.qty;
    });
    // skip left label
    for(let k=0;k<sums.length;k++){
      totalCells[k+1].textContent=String(sums[k]);
    }
    // ---- publish to Firebase
    publishTotals( currentTotalsObject() );
  }

  function fullRender(){
    renderHeader();
    for(let i=0;i<rows.length;i++){
      const rc = (i%2===0) ? "row-odd" : "row-even";
      const left=cell(rc+" left", i);
      const meta=document.createElement('div'); meta.className="meta";
      const title=document.createElement('div'); title.textContent=(i+1)+"번 테이블"; meta.appendChild(title);
      const reset=document.createElement('button'); reset.className="btn rowReset small"; reset.textContent="행 초기화";
      reset.onclick=()=>{ const gid=rows[i].groupId; rows[i]=emptyRow(); rows[i].groupId=gid; save(); fullRender(); };
      meta.appendChild(reset); left.appendChild(meta); grid.appendChild(left);

      for(let m=0;m<CONFIG.menus.length;m++){ const d=cell(rc, i); grid.appendChild(d); drawMenuButtons(d,i,m); }
      const c1=cell(rc,i); c1.innerHTML='<div class="bevbox"></div>'; grid.appendChild(c1); drawBeverage(c1,i,"COLA");
      const c2=cell(rc,i); c2.innerHTML='<div class="bevbox"></div>'; grid.appendChild(c2); drawBeverage(c2,i,"CIDER");
      const c3=cell(rc,i); c3.innerHTML='<div class="bevbox"></div>'; grid.appendChild(c3); drawBeverage(c3,i,"ZERO");

      const tcell=cell(rc,i); grid.appendChild(tcell); drawTime(tcell,i);

      const dcell=cell(rc,i); grid.appendChild(dcell); const chk=document.createElement('input'); chk.type="checkbox"; chk.checked=rows[i].done; chk.disabled=!isCompletable(i);
      chk.onchange=()=>{
        if(!chk.checked){ rows[i].done=false; save(); renderRow(i); return; }
        if(rows[i].groupId){
          const id=rows[i].groupId; const leader=groupLeader(id);
          if(i!==leader){ chk.checked=false; return; }
          if(!(groupAnyOrdered(id) && !groupAnyActive(id))){ chk.checked=false; return; }
          groupMembers(id).forEach(t=> rows[t].done=true);
        }else{
          if(!isCompletable(i)){ chk.checked=false; return; }
          rows[i].done=true;
        }
        save(); renderRow(i);
      };
      dcell.appendChild(chk);

      const pcell=cell(rc+" price",i); grid.appendChild(pcell); pcell.textContent=fmtWon.format(rowPrice(rows[i]))+"원";
    }
    renderFooter();
    // 초기 0 합계도 송신
    publishTotals( currentTotalsObject() );
  }

  // toolbar (select/group)
  const $reset=$("#resetAll"), $toggle=$("#toggleSelect"), $make=$("#makeGroup"), $break=$("#breakGroup");
  $reset.onclick=()=>{ if(!confirm("모든 내용을 초기화할까요?")) return; store = emptyStore(); rows=store.rows; groups=store.groups; save(); fullRender(); };
  $toggle.onclick=()=>{ ui.select=!ui.select; ui.selected.clear(); updateSelectMode(); };
  function updateSelectMode(){
    const lefts = grid.querySelectorAll('.left .meta');
    lefts.forEach((meta, idx)=>{
      const exist = meta.querySelector('label.sel');
      if(ui.select){
        if(!exist){
          const label=document.createElement('label'); label.className="sel"; label.style.display="flex"; label.style.alignItems="center"; label.style.gap="6px";
          const cb=document.createElement('input'); cb.type="checkbox"; cb.onchange=()=>{ if(cb.checked) ui.selected.add(idx); else ui.selected.delete(idx); updateGroupButtons(); };
          label.appendChild(cb); label.appendChild(document.createTextNode((idx+1)+"번 테이블"));
          meta.firstChild && meta.firstChild.remove();
          meta.insertBefore(label, meta.firstChild || null);
        }
      }else{
        if(exist){
          exist.remove();
          const title=document.createElement('div'); title.textContent=(idx+1)+"번 테이블";
          meta.insertBefore(title, meta.firstChild || null);
        }
      }
    });
    updateGroupButtons();
  }
  function updateGroupButtons(){
    const arr=[...ui.selected];
    $make.disabled = !(ui.select && arr.length>=2 && arr.every(i=> rows[i].groupId===null));
    $break.disabled = !(ui.select && arr.some(i=> rows[i].groupId!==null));
  }
  $make.onclick=()=>{
    const arr=[...ui.selected].sort((a,b)=>a-b); if(arr.length<2) return;
    const id=store.nextId++; const g={id, members:arr, time:null,timePlus:null,timeStamp:null};
    groups.push(g); arr.forEach(i=> rows[i].groupId=id);
    ui.selected.clear(); save(); fullRender();
  };
  $break.onclick=()=>{
    const arr=[...ui.selected]; if(arr.length===0) return;
    const by={}; arr.forEach(i=>{ const gid=rows[i].groupId; if(gid!==null){ (by[gid]||(by[gid]=[])).push(i);} });
    Object.entries(by).forEach(([gidStr, list])=>{
      const gid=Number(gidStr); const g=groupBy(gid); if(!g) return;
      list.forEach(i=>{ rows[i].groupId=null; if(g.time){ rows[i].time=g.time; rows[i].timePlus=g.timePlus; rows[i].timeStamp=g.timeStamp; } });
      g.members = g.members.filter(i=> !list.includes(i));
      if(g.members.length===0){ groups = groups.filter(x=>x.id!==gid); }
    });
    ui.selected.clear(); save(); fullRender();
  };

  fullRender();
})();
</script>
</body>
</html>